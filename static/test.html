
<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">

  <title>CodePen - Angular with Server</title>

  <base href="http://localhost:5000">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <style>@import url("https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css");
@import url("https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css");

.red {
  color: red;  
}

.page-header {
  text-align: center;
  padding-top: 0em;
  margin-top: 0em;
}
.page-header h2, small {
  padding: 0.2em;
  margin: 0em;
}

form button {
  float: right;
}</style>

</head>

<body>

  <div class="page-header">
  <h2>FABuLAS</h2><small>Flask-Angular-Boostrap-YOU-Linux-Apache-SQL</small> 
</div>
<div  ng-app="app" id="app" class="container">
  <!-- controller create necessay data varible used inside scope -->
  <div ng-controller="logoutController" class="container" ng-show="global.user">
      <a ng-click="logout()">Logout</a>
  </div>
  <!-- controller create necessay data varible used inside scope -->
  <div ng-controller="loginController" class="container" ng-show="! (global.user)">
    <h4>Login</h4>
    <!-- set action and method for regular form submt -->
    <form action="/login" method="post" role="form"> 
      <div ng-class="{'red':errors.email}" class="form-group">
        <div class="input-group">
          <span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span><input type="text" name="username" placeholder="Email" ng-model="inputs.username" class="form-control"> 
        </div>
        <span ng-show="errors.email">{{errors.email}}</span> 
      </div>

      <div ng-class="{'red':errors.password}" class="form-group"> 
        <div class="input-group">
          <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span><input type="text" name="password" placeholder="Password" ng-model="inputs.password" class="form-control"> 
        </div>
        <span ng-show="errors.password">{{errors.password}}</span> 
      </div>

      <!-- <button type="submit">Sync Submit</button> -->
      <button type="button" ng-click="login()" class="btn btn-primary">Login</button>
    </form>
  </div>

  <!-- controller create necessay data varible used inside scope -->
  <div ng-controller="createUserController" class="container" ng-show="! (global.user)">
    <a class="trigger" ng-click="show=!show">Register new user</a>
    <div ng-show="show">
      <h4>Create User</h4>
      <!-- set action and method for regular form submt -->
      <form action="/users" method="post" role="form"> 
        <div ng-class="{'red':errors.email}" class="form-group">
          <div class="input-group">
            <span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span><input type="text" name="email" placeholder="Email" ng-model="inputs.email" class="form-control"> 
          </div>
          <span ng-show="errors.email">{{errors.email}}</span> 
        </div>

        <div ng-class="{'red':errors.password}" class="form-group"> 
          <div class="input-group">
            <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span><input type="text" name="password" placeholder="Password" ng-model="inputs.password" class="form-control"> 
          </div>
          <span ng-show="errors.password">{{errors.password}}</span> 
        </div>

        <!-- <button type="submit">Sync Submit</button> -->
        <button type="button" ng-click="createUser()" class="btn btn-primary">Register</button>
      </form>
      </div>  </div>

  <!-- another controller -->
  <div ng-controller="getUsersController" class="container" ng-show="global.user">
    <h4>Search User</h4>
    <div class="input-group">
      <input type="text" placeholder="Email" ng-model="query" class="form-control" />
      <span class="input-group-btn">
        <button ng-click="queryUsers()" class="btn btn-default">Search</button>
      </span>
    </div>
    <h5 class="form-group">The following are users retrieved from server:</h5>
    <input ng-model="keyword" placeholder="Keyword" class="form-control form-group">    
    <ul class="list-group">
      <!-- loop and phones is varible created by contoller function -->
      <li ng-repeat="user in users | filter:keyword" class="list-group-item">
        <span ng-click="deleteUser({{user.id}})" class="badge">x</span>
        <span>{{user.id}}</span> - <span>{{user.email}}</span>
      </li>
    </ul>
  </div>
</div>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/angular.min.js"></script>

  <script>
    var app = angular.module('app', []);

app.factory("service", function() {
  return { global: { user: null } }
});

app.controller('getUsersController', function ($scope, $http, service) {
  $scope.global = service.global;

  $scope.getUsers = function() {
    //$http.get('users).
    //use jsonp instead of get to do local quick prototype
    $http.jsonp('/json/users?callback=JSON_CALLBACK').
      success(function (resp) {$scope.getUsersSuccess(resp)}).
      error(function (resp) {$scope.error(resp)});

    //simulate with fake response
    //$scope.getUsersSuccess({"data": [{"email":"fei@me.com", "password":"fei"}]}, "message":"Users Retrieved");
  }
  $scope.queryUsers = function() {
    if ($scope.query) {
      //$http.get('users/query?email='+$scope.query).
      //use jsonp instead of get to do local quick prototype
      $http.jsonp('/json/users/query?callback=JSON_CALLBACK&'+'email='+$scope.query).
        success(function (resp) {$scope.getUsersSuccess(resp)}).
        error(function (resp) {$scope.error(resp)});
    } else {
      $scope.getUsers();
    }
  }
  $scope.getUsersSuccess = function(resp) {
    if (resp.errors) $scope.errors = resp.errors;
    if (resp.message) $scope.message = resp.message;
    if (resp.data) $scope.users = resp.data;
    console.log("users loaded");
  }

  $scope.deleteUser = function(id) {
    //$http.delete('/users/'+id).
    //use jsonp with special url to do quick local test
    $http.jsonp('/json/users/delete/'+id+'?callback=JSON_CALLBACK').
      success(function (resp) {$scope.deleteUsersSuccess(resp)}).
      error(function (resp) {$scope.error(resp)});    
  }
  $scope.deleteUsersSuccess = function(resp) {
    if (resp.errors) $scope.errors = resp.errors;
    if (resp.message) $scope.message = resp.message;
    console.log("user deleted");
    //make sure get users after delete completed
    $scope.getUsers();
  }

  $scope.error = function(data) {
    $scope.status = "error";
  }

  //initial users load
  $scope.getUsers();
});

app.controller('loginController', function ($scope, $http, service) {
  $scope.global = service.global;
  $scope.form = {"inputs": {}, "errors": {}};

  $scope.login = function() {
    //$http.post('/static/login', $scope.form.inputs).
    //use jsonp and special get to do local quick prototype
    $http.jsonp('/static/login?callback=JSON_CALLBACK&'+decodeURIComponent($.param($scope.inputs))).
      success(function(resp) {$scope.loginSuccess(resp);});

    //use fake response to simulate
    //resp = {"errors": {"email": "Invalid Email"}, "message": "Errors"};
    //$scope.createUserSuccess(resp);
  };
  $scope.loginSuccess = function(resp) {
    if (resp.errors) $scope.errors = resp.errors;
    if (resp.message) $scope.message = resp.message;
    if (resp.data) $scope.global.user = resp.data;
    // invoke another controller
    refresh();
  };

  $scope.error = function(resp) {
    $scope.status = "error";
  }
});

app.controller('logoutController', function ($scope, $http, service) {
  $scope.global = service.global;

  $scope.logout = function() {
    //$http.post('/logout', $scope.form.inputs).
    //use jsonp and special get to do local quick prototype
    $http.jsonp('/logout?callback=JSON_CALLBACK').
      success(function(resp) {$scope.logoutSuccess(resp);});

    //use fake response to simulate
    //resp = {"errors": {"email": "Invalid Email"}, "message": "Errors"};
    //$scope.createUserSuccess(resp);
  };
  $scope.logoutSuccess = function(resp) {
    if (resp.errors) $scope.errors = resp.errors;
    if (resp.message) $scope.message = resp.message;
    service.global.user = null;
    // invoke another controller
    refresh();
  };

  $scope.error = function(resp) {
    $scope.status = "error";
  }
});

app.controller('createUserController', function ($scope, $http, service) {
  $scope.global = service.global;
  $scope.show = false;
  $scope.form = {"inputs": {}, "errors": {}};

  $scope.createUser = function() {
    //$http.post('/users', $scope.form.inputs).
    //use jsonp and special get to do local quick prototype
    $http.jsonp('/static/json/users/create?callback=JSON_CALLBACK&'+decodeURIComponent($.param($scope.inputs))).
      success(function(resp) {$scope.createUserSuccess(resp);});

    //use fake response to simulate
    //resp = {"errors": {"email": "Invalid Email"}, "message": "Errors"};
    //$scope.createUserSuccess(resp);
  };
  $scope.createUserSuccess = function(resp) {
    if (resp.errors) $scope.errors = resp.errors;
    if (resp.message) $scope.message = resp.message;
    // invoke another controller
    refresh();
  };

  $scope.error = function(resp) {
    $scope.status = "error";
  }
});

// NO need to use $scope.$apply with scope function
function refresh() {
  var appElement = $('[ng-controller=getUsersController]');
  var appScope = angular.element(appElement).scope();
  appScope.getUsers();
}

// use $scope.$apply to update scope data with non-scope function
function setMessage(msg) {
  var appElement = $('[ng-controller=createUsersController]');
  var appScope = angular.element(appElement).scope();
  appScope.$apply(function(){
    appScope.message = msg;
  })
}
    //@ sourceURL=pen.js
  </script>

</body>

</html>