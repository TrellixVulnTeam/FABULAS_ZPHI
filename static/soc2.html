
<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">

  <title>SOC jQuery</title>

  <style>
  @import url("/static/ui.css");

.filters {
  display: inline-block;
  width: 320px;
  vertical-align: top;
  margin-right: -4px;
  padding: 1em;
}
.filters h4 {
  margin: 1em 0 0.25em 0;
}
.filters table { width: 100%; }
.filters td { width: 1.4em; text-align: center; }
.filters tr > td:first-child { text-align: left; }

.filters label {
  margin-right: 0.5em;
}

.result {
  display: inline-block;
  vertical-align: top;
  width: calc(100% - 320px);
  padding: 1em;
}
.result > h4 {
  padding: 1em;
  background-color: lightgrey;
  width: 300px;
  border-radius: 10px 10px 0 0;
  border: 1px solid grey;
  border-width: 0px 0px 0 0px;
}

.course {
  width: 100%;
  height: 2em;
  overflow: hidden;
  border: 1px solid grey;
  border-width: 1px 1px 0px 1px;
}

.course.expanded {
  height: auto;  
}

.course > .title {
  background-color: lightgrey;
  padding: 0.5em;
}

.course > .header {
  padding: 0.5em;
}
.course > .title > span:nth-of-type(1):after {
  content: ":";
}
.course > .title > span:nth-of-type(2):after {
  content: ":";
}
.course > .title > span:nth-of-type(3) {
  display: inline-block;
  margin-right: 2em;
}

.course > .section {
  padding: 0.5em;
  border-bottom: 1px solid lightgrey;
}

.course > .section.OS-false > span:nth-of-type(1) {
  background-color: red;
}
.course > .section.OS-true > span:nth-of-type(1) {
  background-color: green;
}
.course > .section > span:nth-of-type(1) {
  display: inline-block;
  padding: 0.4em 0 0.2em 0;
  width: 2em;
  margin-right: 1em;
  text-align: center;
  color: white;
}

.course > .section > ul {
  display: inline-block;
  list-style-type: none;
  margin-left: 1em;
  vertical-align: middle;
}

.course > .section > ul > li > span:nth-of-type(1) {
  display: inline-block;
  margin-right: 1em;
  width: 12em;
}
.course > .section > ul > li > span:nth-of-type(2) {
  display: inline-block;
  width: 3em;
  margin-right: 1em;
}

.page {
  display: none;
}

#queries {
  display: inline-block;
  position: relative;
  left: 50%;
  transform: translateX(-50%);
  border: 1px solid black;
  background-color: lightgrey;
  padding: 1em;
}

.campus, .level {
  display: inline-block;
  width: 50%;
  margin-right: -4px;
  vertical-align: top;
  border: 0px solid black;
}

.term > label {
  display: inline-block;
}

.campus > label, .level > label {
  display: block;
  min-width: 10em;
}

#queries div > h3 {
  margin-bottom: 0.5em;
}

.subject-search, .term {
  border-bottom: 1px solid black;
  margin-bottom: 1em;
  padding-bottom: 1em;
}

.subject-search > a {
  display: block;
  width: 4em;
  margin-left: auto;
}

.school-search > a {
  float: right;
  width: 4em;
}

#subjects, #home {
  display: none;
}

#subject-query { height: 9em; }
#location-filters { height: 9em; }

</style>

</head>

<body>
<div id="subjects" class="page">
  <div id="courses">
    <div class="filters">

      <form class="window" action="" id="subject-query">
        <div class="controls">
          <span class="title">Choose Subjects</span>
          <input type="submit" value="Submit" onclick="$(this).parent().parent().removeClass('max all').addClass('min')" />
          <i onclick="$(this).parent().parent().removeClass('min all').addClass('max')"></i><i onclick="$(this).parent().parent().removeClass('min max').addClass('all')"></i><i onclick="$(this).parent().parent().removeClass('max all').addClass('min')"></i>
        </div>
        <div class="content">
          <div class="multi-check">
          </div>
        </div>
      </form>

      <form class="window">
        <div class="controls">
          <span class="title">Status Filter</span>
          <input type="submit" value="Submit" onclick="$(this).parent().parent().removeClass('max all').addClass('min')" />
          <i onclick="$(this).parent().parent().removeClass('min all').addClass('max')"></i><i onclick="$(this).parent().parent().removeClass('min max').addClass('all')"></i><i onclick="$(this).parent().parent().removeClass('max all').addClass('min')"></i>
        </div>
        <div class="content">
          <div class="multi-check">
            <label><input type="checkbox" data-filter=".section.OS-true" checked /><span>Open</span></label>
            <label><input type="checkbox" data-filter=".section.OS-false" checked /><span>Close</span></label>
          </div>
        </div>
      </form>

      <form class="window">
        <div class="controls">
          <span class="title">Day/Time Filter</span>
          <input type="submit" value="Submit" onclick="$(this).parent().parent().removeClass('max all').addClass('min')" />
          <i onclick="$(this).parent().parent().removeClass('min all').addClass('max')"></i><i onclick="$(this).parent().parent().removeClass('min max').addClass('all')"></i><i onclick="$(this).parent().parent().removeClass('max all').addClass('min')"></i>
        </div>
        <div class="content">
          <table>
            <tr>
              <td></td><td>M</td><td>T</td><td>W</td><td>Th</td><td>F</td><td>S</td><td>SU</td>
            </tr>
            <tr>
              <td>Morning</td>
              <td><input type="checkbox" data-filter=".section.MT-MA" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-TA" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-WA" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-THA" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-FA" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-SA" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-SUA" checked /></td>
            </tr>
            <tr>
              <td>Afteroon</td>
              <td><input type="checkbox" data-filter=".section.MT-MP" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-TP" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-WP" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-THP" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-FP" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-SP" checked /></td>
              <td><input type="checkbox" data-filter=".section.MT-SUP" checked /></td>
            </tr>
          </table>
        </div>
      </form>

      <form class="window" id="location-filters">
        <div class="controls">
          <span class="title">Location Filter</span>
          <input type="submit" value="Submit" onclick="$(this).parent().parent().removeClass('max all').addClass('min')" />
          <i onclick="$(this).parent().parent().removeClass('min all').addClass('max')"></i><i onclick="$(this).parent().parent().removeClass('min max').addClass('all')"></i><i onclick="$(this).parent().parent().removeClass('max all').addClass('min')"></i>
        </div>
        <div class="content">
          <div class="multi-check">
          </div>
        </div>
      </form>

      <form class="window min" id="level-filters">
        <div class="controls">
          <span class="title">Level Filter</span>
          <input type="submit" value="Submit" onclick="$(this).parent().parent().removeClass('max all').addClass('min')" />
          <i onclick="$(this).parent().parent().removeClass('min all').addClass('max')"></i><i onclick="$(this).parent().parent().removeClass('min max').addClass('all')"></i><i onclick="$(this).parent().parent().removeClass('max all').addClass('min')"></i>
        </div>
        <div class="content">
          <div class="multi-check">
          </div>
        </div>
      </form>

      <form class="window min" id="unit-filters">
        <div class="controls">
          <span class="title">Unit Filter</span>
          <input type="submit" value="Submit" onclick="$(this).parent().parent().removeClass('max all').addClass('min')" />
          <i onclick="$(this).parent().parent().removeClass('min all').addClass('max')"></i><i onclick="$(this).parent().parent().removeClass('min max').addClass('all')"></i><i onclick="$(this).parent().parent().removeClass('max all').addClass('min')"></i>
        </div>
        <div class="content">
          <div class="multi-check">
          </div>
        </div>
      </form>

      <form class="window min" id="subject-filters">
        <div class="controls">
          <span class="title">Subject Filter</span>
          <input type="submit" value="Submit" onclick="$(this).parent().parent().removeClass('max all').addClass('min')" />
          <i onclick="$(this).parent().parent().removeClass('min all').addClass('max')"></i><i onclick="$(this).parent().parent().removeClass('min max').addClass('all')"></i><i onclick="$(this).parent().parent().removeClass('max all').addClass('min')"></i>
        </div>
        <div class="content">
          <div class="multi-check">
          </div>
        </div>
      </form>

      <div class="dynamic-filters"></div>
    </div>
    <div class="result">
      <a href="https://github.com/tevjef/Rutgers-Course-Tracker/blob/master/response-samples/courses-nk-nb.json">sample data</a>
      <h4 class="view">+  Search Results</h4>
      <div class="data"></div>
    </div>
  </div>
</div>
<div id="home">
  <div id="message"></div>
  <div id="queries">
    <div class="term">
      <h3>Term</h3>
      <label><input type="radio" name="term" data-query-semester="92015" checked /> Fall 2015</label>
      <label><input type="radio" name="term" data-query-semester="72015" /> Summer 2015</label>
      <label><input type="radio" name="term" data-query-semester="12015" /> Spring 2015</label>
    </div>
    <div class="subject-search">
      <div class="campus">
        <h3>Campuse</h3>
        <label><input type="checkbox" data-query-campus="NB" checked /> New Brunswick</label>
        <label><input type="checkbox" data-query-campus="NK" /> Newark</label>
        <label><input type="checkbox" data-query-campus="CM" /> Camden</label>      
      </div>
      <div class="level">
        <h3>Level</h3>
        <label><input type="checkbox" data-query-level="U" checked /> Undergraduate</label>
        <label><input type="checkbox" data-query-level="G" checked /> Graduate</label>
      </div>
      <a id="search-subject">Continue</a>
    </div>
    <div class="school-search">
      <h3>School</h3>
      <select name="school" data-query-school>
        <option value="01">School Arts & Scient</option>
        <option value="22">Rutgers Business School</option>
      </select>
      <a id="search-school">Continue</a>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>

var params = parseQueryString();
displayPage(params.hashtag);
loadReferences();    

var allUnits=[], allSubjects=[], allLevels=[], allLocations=[]; allCampuses=[]; 


var expanded = false;
$(".result > h4").click(function() {
  if (expanded) {
    $('.course').removeClass("expanded");
  }
  else {
    $('.course').addClass("expanded");
  }
  expanded = !expanded;
});

$("#search-subject").click(function() {
  console.log("subject search");
  var q = "#subjects?";
  if ($("[data-query-semester]:checked").length > 0)
    q = q + "semester="+$("[data-query-semester]:checked").map(function() {
      return $(this).data("query-semester");
    }).get().join(',');
  if ($("[data-query-campus]:checked").length > 0)
    q = q + "&campus="+$("[data-query-campus]:checked").map(function() {
      return $(this).data("query-campus");
    }).get().join(',');
  if ($("[data-query-level]:checked").length > 0)
    q = q + "&level="+$("[data-query-level]:checked").map(function() {
      return $(this).data("query-level");
    }).get().join(',');

  console.log("change URL: "+q);
  window.location.hash = q;
});

$("#search-school").click(function() {
  console.log("search school");
  var q = "#schools?";
  if ($("[data-query-semester]:checked").length > 0)
    q = q + "semester="+$("[data-query-semester]:checked").map(function() {
      return $(this).data("query-semester");
    }).get().join(',');
  if ($("[data-query-school]").length > 0)
    q = q + "&school="+$("[data-query-school]").map(function() {
      return $(this).val();
    }).get().join(',');

  console.log("change URL: "+q);
  window.location.hash = q;
});

// TODO query
$("#subject-query").submit(function() {
  alert("submit subject change");
});

//TODO review if this is correct only reload on hashchange
$(window).on('hashchange', function(e){
  //reloadData();
  console.log("reload page");
  location.reload();
});

function displayPage(page) {
  console.log("page: "+page);
  if (page != null) {
    if (page == "#subjects" || page == "#schools") {
      console.log("show subjects page");
      $("#home").hide();    
      $("#subjects").show();
      reloadData();
      return;
    }
  }
  console.log("show home page");
  $("#home").show();    
  $("#subjects").hide();
}

var subjectList = null;
function loadReferences() {
  if (subjectList == null) { 
    console.log("loading subject list");
    $.getJSON( "/static/subjects.json.gz", function( data ) {
      subjectList = data;
      var s = "";
      for (k in subjectList) {
        s = s+"<label><input type='checkbox' /><span>"+
          subjectList[k].code+" - "+subjectList[k].description+"</span></label>";
      }
      $("#subject-query .multi-check").append(s);
    });
  }
}

function reloadData() {
  $.getJSON( "/static/all.json.gz", function( data ) {
    allUnits=[]; allSubjects=[]; allLevels=[]; allLocations=[]; allCampuses=[];  
    parseData(data);
    applyQueries(params);
    applyFilters();
    $(".title").click(function() {
      $(this).parent().toggleClass("expanded");
    });
    $("[data-filter]").click(function() {
      applyFilters();
    });
  });
}

function parseData(data) {
  var courses = "";
  for(var i=0; i<data.length; i++) {
    // filter course based on campus/unit/subject/level

    // format data use data as-is amap or format on server and assign class
    courses = courses + createCourse(data[i]);
  }
  $(".data").empty();
  $(".dynamic-filters").empty();
  console.log("refreshing data");
  $(courses).appendTo(".data");
  $(createFilters(allLocations, ".section.")).appendTo("#location-filters .multi-check");
  $(createFilters(allLevels, ".course.")).appendTo("#level-filters .multi-check");
  $(createFilters(allUnits, ".course.")).appendTo("#unit-filters .multi-check");
  $(createFilters(allSubjects, ".course.")).appendTo("#subject-filters .multi-check");
}

function applyQueries(params) {
  // parse query string and create filter array
  // handle campus, level, subject, semester
  // var params = {"level":["G", "U"], "campus":["NB"], "subject":["351"]};
  var queries = [];
  if (params.level != null && params.level.length == 1) {
    if ("G"==params.level[0]) {
      queries.push(".course.LVL-0");
      queries.push(".course.LVL-100");
      queries.push(".course.LVL-200");
      queries.push(".course.LVL-300");
      queries.push(".course.LVL-400");
    }
    if ("U"==params.level[0]) {
      queries.push(".course.LVL-500");
      queries.push(".course.LVL-600");
      queries.push(".course.LVL-700");
      queries.push(".course.LVL-800");
    }
  }
  if (params.campus != null && params.campus.length > 0) {
    for(var k in allCampuses) {
      if (params.campus.indexOf(allCampuses[k]) < 0)
        queries.push(".section."+k);
    }
  }
  if (params.subject != null) {
    for(var k in allSubjects) {
      if (params.subject.indexOf(allSubjects[k]) < 0)
        queries.push(".course."+k);
    }
  }
  if (params.school != null) {
    for(var k in allUnits) {
      if (params.school.indexOf(allUnits[k]) < 0)
        queries.push(".course."+k);
    }
  }

  console.log(queries);

  $("<style type='text/css' id='queries'> "+queries.join(",")+",.course.hide"+"{display:none;} </style>").appendTo("head");

  $(".course").filter(function(){
      return $(this).find(".section:visible").length == 0;
  }).addClass("hide");

  for(var q in queries) {
    $("[data-filter='"+queries[q]+"']").parent().remove();
  }
}

function parseQueryString() {
    var params = {}, queries, temp, i, l;

    var queryString = decodeURIComponent(window.location.hash);
    console.log(queryString);
    if (queryString != null) {
      params.hashtag = queryString.split("?")[0];
      queryString = queryString.split("?")[1];
    } 
    console.log(queryString);
    if (queryString == null) return params;

    // Split into key/value pairs
    queries = queryString.split("&");
 
    // Convert the array of strings into an object
    for ( i = 0, l = queries.length; i < l; i++ ) {
        temp = queries[i].split('=');
        if (temp.length == 2)
          params[temp[0]] = temp[1].split(",");
    }
 
    console.log(params);
    return params;
}


function applyFilters() {
  var filters = $("[data-filter]:not(:checked)").map(function() {
    return $(this).data("filter");
  }).get().join(',');

  $(".course").removeClass("hide");

  $("#filters").remove();
  $("<style type='text/css' id='filters'> "+filters+",.course.hide"+ "{display:none;} </style>").appendTo("head");

  $(".course").filter(function(){
      return $(this).find(".section:visible").length == 0;
  }).addClass("hide");
}

var template = "<label><input type='checkbox' data-filter='{filter-value}' checked /><span>{display-value}</span></label>";
function createFilters(filter, prefix) {
  var s = "";
  for(var k in filter) {
    s = s + template.replace("{filter-value}", prefix+k).replace("{display-value}", filter[k]);
  }
  return s;
}

function createCourse(c) {
  var labels = [];
  labels.push("OUC-"+c.offeringUnitCode);
  allUnits["OUC-"+c.offeringUnitCode] = c.offeringUnitCode;

  labels.push("SUB-"+c.subject);
  allSubjects["SUB-"+c.subject] = c.subject;

  labels.push("LVL-" + ((Number(c.courseNumber)-Number(c.courseNumber)%100)) );
  allLevels["LVL-"+((Number(c.courseNumber)-Number(c.courseNumber)%100))] = ((Number(c.courseNumber)-Number(c.courseNumber)%100));

  var sections = "";
  for(var i=0; i<c.sections.length; i++) {
    var s = createSection(c.sections[i]);
    sections = sections + s.content;
  }

  var content = "<div class='course "+labels.join(" ")+"'>"+"<div class='title'>"+
    "<span>"+c.offeringUnitCode+"</span>"+
    "<span>"+c.subject+"</span>"+
    "<span>"+c.courseNumber+"</span>"+
    "<span>"+c.title+"</span>"+"</div>"+
    sections+
    "</div>";

  return content;
}

function createSection(s) {
  var labels = [];
  var content = ""
  var meetings = "";
  for(var i=0; i<s.meetingTimes.length; i++) {
    var m = createMeeting(s.meetingTimes[i]);
    mergeFrom(labels, m.labels);
    meetings = meetings + "<li>"+m.content+"</li>";
  }
  labels["OS-"+s.openStatus] = "";
  labels["CC-"+s.campusCode] = s.campusCode;
  allCampuses["CC-"+s.campusCode] = s.campusCode;

  content = "<div class='section "+keys(labels).join(" ")+"'>"+
    "<span>"+s.number+"</span>"+"<span>"+s.index+"</span>"+
    "<ul>"+meetings+"</ul>"+
    "</div>";

  return {"labels":labels, "content":content};
}

function createMeeting(m) {
  var labels = [];
  var content = "";
  if (m.meetingDay == null) {
    content = "<span>Hours by Arrangement</span>";
  } else {
    content = "<span>"+m.meetingDay+"  "+m.startTime+" - "+m.endTime+"</span>";
    labels["MT-"+m.meetingDay+m.pmCode] = "";
  }

  if (m.campusAbbrev != null) {
    content += "<span>"+m.campusAbbrev+"</span>";
    //TODO fix d/c, **, other invalid character etc
    var cc = m.campusAbbrev.replace("/", "N").replace("**", "");
    if (cc.length > 0) {
      labels["LC-"+cc] = cc;
      allLocations["LC-"+cc] = cc;
    }
  } else {
    content += "<span></span>";
  }
  if (m.buildingCode != null) {
    content += "<span>"+m.buildingCode+"-"+m.roomNumber+"</span>";
  } else {
    content += "<span></span>";
  }

  return {"labels":labels, "content":content};
}

function keys(o) {
  var keys = [];
  for(k in o) keys.push(k);
  return keys;
}

function mergeFrom(o1, o2) {
  for (var attr in o2) { o1[attr] = o2[attr]; }
}


// var courses = [{
//   "subject": "198",
//   "credits": 3,
//   "offeringUnitCode": "21",
//   "title": "INTRO TO COMPUTERS",
//   "campusCode": "NK",
//   "courseNumber": "100",

//   "sections": [{
//     "openStatus": true,
//     "number": "70",
//     "index": "08596",
//     "instructors": [{"name": "VILLANEUVA, D"}],

//     "meetingTimes": [{
//       "meetingDay": "W",
//       "pmCode": "P",
//       "startTime": "0600",
//       "endTime": "0720",
//       "buildingCode": "ENG",
//       "roomNumber": "309",
//       "campusAbbrev": "NWK"
//     }]
//   }]
// }];

</script>

</body>

</html>